/*
 * jQuery MultiSelect UI Widget 1.12
 * Copyright (c) 2011 Eric Hynds
 *
 * http://www.erichynds.com/jquery/jquery-ui-multiselect-widget/
 *
 * Depends:
 *   - jQuery 1.4.2+
 *   - jQuery UI 1.8 widget factory
 *
 * Optional:
 *   - jQuery UI effects
 *   - jQuery UI position utility
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 */
(function(b){var a=0;b.widget("ech.multiselect",{options:{header:!0,height:175,minWidth:225,classes:"",checkAllText:"Check all",uncheckAllText:"Uncheck all",noneSelectedText:"Select options",selectedText:"# selected",selectedList:0,show:"",hide:"",autoOpen:!1,multiple:!0,position:{}},_create:function(){var e=this.element.hide(),d=this.options;this.speed=b.fx.speeds._default;this._isOpen=!1;e=(this.button=b('<button type="button"><span class="ui-icon ui-icon-triangle-2-n-s"></span></button>')).addClass("ui-multiselect ui-widget ui-state-default ui-corner-all").addClass(d.classes).attr({title:e.attr("title"),"aria-haspopup":!0,tabIndex:e.attr("tabIndex")}).insertAfter(e);(this.buttonlabel=b("<span />")).html(d.noneSelectedText).appendTo(e);var e=(this.menu=b("<div />")).addClass("ui-multiselect-menu ui-widget ui-widget-content ui-corner-all").addClass(d.classes).appendTo(document.body),f=(this.header=b("<div />")).addClass("ui-widget-header ui-corner-all ui-multiselect-header ui-helper-clearfix").appendTo(e);(this.headerLinkContainer=b("<ul />")).addClass("ui-helper-reset").html(function(){return !0===d.header?'<li><a class="ui-multiselect-all" href="#"><span class="ui-icon ui-icon-check"></span><span>'+d.checkAllText+'</span></a></li><li><a class="ui-multiselect-none" href="#"><span class="ui-icon ui-icon-closethick"></span><span>'+d.uncheckAllText+"</span></a></li>":"string"===typeof d.header?"<li>"+d.header+"</li>":""}).append('<li class="ui-multiselect-close"><a href="#" class="ui-multiselect-close"><span class="ui-icon ui-icon-circle-close"></span></a></li>').appendTo(f);(this.checkboxContainer=b("<ul />")).addClass("ui-multiselect-checkboxes ui-helper-reset").appendTo(e);this._bindEvents();this.refresh(!0);d.multiple||e.addClass("ui-multiselect-single")},_init:function(){!1===this.options.header&&this.header.hide();this.options.multiple||this.headerLinkContainer.find(".ui-multiselect-all, .ui-multiselect-none").hide();this.options.autoOpen&&this.open();this.element.is(":disabled")&&this.disable()},refresh:function(j){var d=this.element,p=this.options,o=this.menu,l=this.checkboxContainer,m=[],n=[],k=d.attr("id")||a++;d.find("option").each(function(f){b(this);var i=this.parentNode,t=this.innerHTML,s=this.title,r=this.value,f=this.id||"ui-multiselect-"+k+"-option-"+f,q=this.disabled,c=this.selected,g=["ui-corner-all"];"optgroup"===i.tagName.toLowerCase()&&(i=i.getAttribute("label"),-1===b.inArray(i,m)&&(n.push('<li class="ui-multiselect-optgroup-label"><a href="#">'+i+"</a></li>"),m.push(i)));q&&g.push("ui-state-disabled");c&&!p.multiple&&g.push("ui-state-active");n.push('<li class="'+(q?"ui-multiselect-disabled":"")+'">');n.push('<label for="'+f+'" title="'+s+'" class="'+g.join(" ")+'">');n.push('<input id="'+f+'" name="multiselect_'+k+'" type="'+(p.multiple?"checkbox":"radio")+'" value="'+r+'" title="'+t+'"');c&&(n.push(' checked="checked"'),n.push(' aria-selected="true"'));q&&(n.push(' disabled="disabled"'),n.push(' aria-disabled="true"'));n.push(" /><span>"+t+"</span></label></li>")});l.html(n.join(""));this.labels=o.find("label");this._setButtonWidth();this._setMenuWidth();this.button[0].defaultValue=this.update();j||this._trigger("refresh")},update:function(){var f=this.options,d=this.labels.find("input"),h=d.filter("[checked]"),g=h.length,f=0===g?f.noneSelectedText:b.isFunction(f.selectedText)?f.selectedText.call(this,g,d.length,h.get()):/\d/.test(f.selectedList)&&0<f.selectedList&&g<=f.selectedList?h.map(function(){return b(this).next().text()}).get().join(", "):f.selectedText.replace("#",g).replace("#",d.length);this.buttonlabel.html(f);return f},_bindEvents:function(){function e(){d[d._isOpen?"close":"open"]();return !1}var d=this,f=this.button;f.find("span").bind("click.multiselect",e);f.bind({click:e,keypress:function(c){switch(c.which){case 27:case 38:case 37:d.close();break;case 39:case 40:d.open()}},mouseenter:function(){f.hasClass("ui-state-disabled")||b(this).addClass("ui-state-hover")},mouseleave:function(){b(this).removeClass("ui-state-hover")},focus:function(){f.hasClass("ui-state-disabled")||b(this).addClass("ui-state-focus")},blur:function(){b(this).removeClass("ui-state-focus")}});this.header.delegate("a","click.multiselect",function(c){if(b(this).hasClass("ui-multiselect-close")){d.close()}else{d[b(this).hasClass("ui-multiselect-all")?"checkAll":"uncheckAll"]()}c.preventDefault()});this.menu.delegate("li.ui-multiselect-optgroup-label a","click.multiselect",function(h){h.preventDefault();var k=b(this),i=k.parent().nextUntil("li.ui-multiselect-optgroup-label").find("input:visible:not(:disabled)"),j=i.get(),k=k.parent().text();!1!==d._trigger("beforeoptgrouptoggle",h,{inputs:j,label:k})&&(d._toggleChecked(i.filter("[checked]").length!==i.length,i),d._trigger("optgrouptoggle",h,{inputs:j,label:k,checked:j[0].checked}))}).delegate("label","mouseenter.multiselect",function(){b(this).hasClass("ui-state-disabled")||(d.labels.removeClass("ui-state-hover"),b(this).addClass("ui-state-hover").find("input").focus())}).delegate("label","keydown.multiselect",function(c){c.preventDefault();switch(c.which){case 9:case 27:d.close();break;case 38:case 40:case 37:case 39:d._traverse(c.which,this);break;case 13:b(this).find("input")[0].click()}}).delegate('input[type="checkbox"], input[type="radio"]',"click.multiselect",function(h){var m=b(this),k=this.value,l=this.checked,j=d.element.find("option");this.disabled||!1===d._trigger("click",h,{value:k,text:this.title,checked:l})?h.preventDefault():(m.focus(),m.attr("aria-selected",l),j.each(function(){if(this.value===k){this.selected=l}else{if(!d.options.multiple){this.selected=!1}}}),d.options.multiple||(d.labels.removeClass("ui-state-active"),m.closest("label").toggleClass("ui-state-active",l),d.close()),d.element.trigger("change"),setTimeout(b.proxy(d.update,d),10))});b(document).bind("mousedown.multiselect",function(c){d._isOpen&&!b.contains(d.menu[0],c.target)&&!b.contains(d.button[0],c.target)&&c.target!==d.button[0]&&d.close()});b(this.element[0].form).bind("reset.multiselect",function(){setTimeout(b.proxy(d.refresh,d),10)})},_setButtonWidth:function(){var d=this.element.outerWidth(),c=this.options;if(/\d/.test(c.minWidth)&&d<c.minWidth){d=c.minWidth}this.button.width(d)},_setMenuWidth:function(){var d=this.menu,c=this.button.outerWidth()-parseInt(d.css("padding-left"),10)-parseInt(d.css("padding-right"),10)-parseInt(d.css("border-right-width"),10)-parseInt(d.css("border-left-width"),10);d.width(c||this.button.outerWidth())},_traverse:function(f,d){var h=b(d),g=38===f||37===f,h=h.parent()[g?"prevAll":"nextAll"]("li:not(.ui-multiselect-disabled, .ui-multiselect-optgroup-label)")[g?"last":"first"]();h.length?h.find("label").trigger("mouseover"):(h=this.menu.find("ul").last(),this.menu.find("label")[g?"last":"first"]().trigger("mouseover"),h.scrollTop(g?h.height():0))},_toggleState:function(d,c){return function(){this.disabled||(this[d]=c);c?this.setAttribute("aria-selected",!0):this.removeAttribute("aria-selected")}},_toggleChecked:function(f,d){var j=d&&d.length?d:this.labels.find("input"),i=this;j.each(this._toggleState("checked",f));j.eq(0).focus();this.update();var g=j.map(function(){return this.value}).get();this.element.find("option").each(function(){!this.disabled&&-1<b.inArray(this.value,g)&&i._toggleState("selected",f).call(this)});j.length&&this.element.trigger("change")},_toggleDisabled:function(c){this.button.attr({disabled:c,"aria-disabled":c})[c?"addClass":"removeClass"]("ui-state-disabled");this.menu.find("input").attr({disabled:c,"aria-disabled":c}).parent()[c?"addClass":"removeClass"]("ui-state-disabled");this.element.attr({disabled:c,"aria-disabled":c})},open:function(){var i=this.button,d=this.menu,n=this.speed,m=this.options;if(!(!1===this._trigger("beforeopen")||i.hasClass("ui-state-disabled")||this._isOpen)){var j=d.find("ul").last(),k=m.show,l=i.offset();b.isArray(m.show)&&(k=m.show[0],n=m.show[1]||this.speed);j.scrollTop(0).height(m.height);b.ui.position&&!b.isEmptyObject(m.position)?(m.position.of=m.position.of||i,d.show().position(m.position).hide().show(k,n)):d.css({top:l.top+i.outerHeight(),left:l.left}).show(k,n);this.labels.eq(0).trigger("mouseover").trigger("mouseenter").find("input").trigger("focus");i.addClass("ui-state-active");this._isOpen=!0;this._trigger("open")}},close:function(){if(!1!==this._trigger("beforeclose")){var e=this.options,d=e.hide,f=this.speed;b.isArray(e.hide)&&(d=e.hide[0],f=e.hide[1]||this.speed);this.menu.hide(d,f);this.button.removeClass("ui-state-active").trigger("blur").trigger("mouseleave");this._isOpen=!1;this._trigger("close")}},enable:function(){this._toggleDisabled(!1)},disable:function(){this._toggleDisabled(!0)},checkAll:function(){this._toggleChecked(!0);this._trigger("checkAll")},uncheckAll:function(){this._toggleChecked(!1);this._trigger("uncheckAll")},getChecked:function(){return this.menu.find("input").filter("[checked]")},destroy:function(){b.Widget.prototype.destroy.call(this);this.button.remove();this.menu.remove();this.element.show();return this},isOpen:function(){return this._isOpen},widget:function(){return this.menu},_setOption:function(e,d){var f=this.menu;switch(e){case"header":f.find("div.ui-multiselect-header")[d?"show":"hide"]();break;case"checkAllText":f.find("a.ui-multiselect-all span").eq(-1).text(d);break;case"uncheckAllText":f.find("a.ui-multiselect-none span").eq(-1).text(d);break;case"height":f.find("ul").last().height(parseInt(d,10));break;case"minWidth":this.options[e]=parseInt(d,10);this._setButtonWidth();this._setMenuWidth();break;case"selectedText":case"selectedList":case"noneSelectedText":this.options[e]=d;this.update();break;case"classes":f.add(this.button).removeClass(this.options.classes).addClass(d)}b.Widget.prototype._setOption.apply(this,arguments)}})})(jQuery);